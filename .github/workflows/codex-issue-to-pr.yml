name: Codex Issue -> PR

on:
  issues:
    types: [labeled]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: codex-issue-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

jobs:
  codex_fix:
    # 「labeled」イベント時、特定ラベルだけで起動（暴発防止）
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.label.name == 'codex-fix' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # ---- 依存の準備（Codex はデフォルトでネットワーク不可なのでここでDL）----
      # Node プロジェクト例（不要なら削除）
      - name: Setup Node (optional)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install Node deps (optional)
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm i; fi

      # Python プロジェクト例（不要なら削除）
      # - name: Setup Python (optional)
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: "3.11"
      # - name: Install Python deps (optional)
      #   run: |
      #     python -m pip install -U pip
      #     if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Rust プロジェクト例（不要なら削除）
      # - name: Setup Rust (optional)
      #   uses: dtolnay/rust-toolchain@stable

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/issue_fix.md
          # 重要：実装させるなら workspace-write
          sandbox: workspace-write
          # Linux/macOS では drop-sudo 推奨（安全側）
          safety-strategy: drop-sudo
          # 任意：モデル/effort を固定したいなら
          # model: "..."
          # effort: "medium"
          # 任意：追加引数（例：json出力や制限）
          # codex-args: '["--json"]'

      # ---- テスト（あなたのプロジェクトに合わせて必ず変更）----
      - name: Verify tests (edit me)
        run: |
          # 例: Node
          if [ -f package.json ]; then npm test --silent; fi
          # 例: Python
          # pytest -q
          # 例: Rust
          # cargo test

      - name: Create PR
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "fix: codex automated fix for issue #${{ github.event.issue.number }}"
          branch: codex/issue-${{ github.event.issue.number }}-${{ github.run_id }}
          title: "Fix: #${{ github.event.issue.number }} ${{ github.event.issue.title }}"
          body: |
            Automated fix generated by Codex for issue #${{ github.event.issue.number }}.

            - Issue: #${{ github.event.issue.number }}
            - Trigger label: codex-fix

      - name: Comment back to Issue with result
        if: always() && github.event_name == 'issues'
        uses: actions/github-script@v7
        env:
          CODEX_FINAL: ${{ steps.run_codex.outputs.final-message }}
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const ok = "${{ job.status }}" === "success";
            const summary = process.env.CODEX_FINAL ? `\n\n---\nCodex final message:\n\n${process.env.CODEX_FINAL}` : "";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: ok
                ? `✅ Codex ran and a PR should be created (see Pull Requests tab).${summary}`
                : `❌ Codex workflow failed. Check Actions logs.${summary}`
            });
